<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>AnantKripa Meeting</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />

<!-- TAILWIND -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
  body {
    background: linear-gradient(180deg,#041022,#0f1724);
    color:white;
    height:100vh;
    overflow:hidden;
  }
  video { object-fit:cover; border-radius:12px; }
  .floating-emoji {
    position: fixed;
    pointer-events:none;
    animation: floatUp 2s ease-out forwards;
    font-size: 70px;
    filter: drop-shadow(0 6px 10px rgba(0,0,0,0.4));
  }
  @keyframes floatUp {
    from { transform:translateY(0); opacity:1; }
    to   { transform:translateY(-220px); opacity:0; }
  }
</style>
</head>
<body class="font-[Inter]">

<!-- TOP BAR -->
<div class="fixed top-0 left-0 right-0 h-14 px-4 flex justify-between items-center bg-black/40 backdrop-blur-md z-50">
  <div class="font-bold text-orange-400 text-lg flex items-center gap-2">
    <span>ğŸ“¿</span> AnantKripa Meet
  </div>
  <div id="roomLabel" class="opacity-80"></div>
</div>


<!-- VIDEO GRID -->
<div id="videos" class="absolute top-14 bottom-20 left-0 right-64 md:right-72 
  p-3 grid gap-3 
  grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5">
</div>


<!-- PARTICIPANTS SIDEBAR -->
<div id="participants"
     class="fixed top-14 bottom-20 right-0 w-64 md:w-72 bg-black/30 backdrop-blur-md p-4 overflow-y-auto hidden md:block">
  <h3 class="text-white text-lg mb-3 font-semibold flex items-center gap-2">
    ğŸ‘¥ Participants
  </h3>
  <div id="usersList" class="space-y-2"></div>
</div>


<!-- MOBILE PARTICIPANTS BUTTON -->
<button onclick="document.getElementById('participants').classList.toggle('hidden')"
  class="fixed right-4 top-16 md:hidden bg-black/40 px-3 py-2 rounded-full text-lg">
  ğŸ‘¥
</button>


<!-- CHAT PANEL -->
<div id="chat"
     class="fixed right-4 bottom-24 w-72 max-h-[60vh] bg-black/40 backdrop-blur-md rounded-xl 
     flex flex-col overflow-hidden z-30">
  <div id="messages" class="messages flex-1 overflow-y-auto p-3 text-sm space-y-2"></div>

  <div class="p-3 flex gap-2">
    <input id="chatInput" class="flex-1 rounded-lg p-2 text-black" placeholder="Messageâ€¦">
    <button id="sendChat" class="bg-orange-500 px-4 py-2 rounded-lg text-white font-bold">Send</button>
  </div>
</div>


<!-- EMOJI PANEL (20+ emojis) -->
<div id="emojiPanel" class="fixed left-4 bottom-24 flex flex-wrap gap-2 w-44 p-2 bg-black/30 backdrop-blur rounded-xl z-30">
  <button class="text-3xl" onclick="localEmoji('ğŸª”')">ğŸª”</button>
  <button class="text-3xl" onclick="localEmoji('ğŸŒ¸')">ğŸŒ¸</button>
  <button class="text-3xl" onclick="localEmoji('ğŸ™')">ğŸ™</button>
  <button class="text-3xl" onclick="localEmoji('ğŸ”¥')">ğŸ”¥</button>
  <button class="text-3xl" onclick="localEmoji('ğŸ’')">ğŸ’</button>
  <button class="text-3xl" onclick="localEmoji('âœ¨')">âœ¨</button>
  <button class="text-3xl" onclick="localEmoji('ğŸ‰')">ğŸ‰</button>
  <button class="text-3xl" onclick="localEmoji('ğŸ’–')">ğŸ’–</button>
  <button class="text-3xl" onclick="localEmoji('ğŸŒŸ')">ğŸŒŸ</button>
  <button class="text-3xl" onclick="localEmoji('ğŸ“¿')">ğŸ“¿</button>
  <button class="text-3xl" onclick="localEmoji('ğŸ””')">ğŸ””</button>
  <button class="text-3xl" onclick="localEmoji('ğŸ¤')">ğŸ¤</button>
  <button class="text-3xl" onclick="localEmoji('ğŸ’«')">ğŸ’«</button>
  <button class="text-3xl" onclick="localEmoji('ğŸ¥')">ğŸ¥</button>
</div>


<!-- BOTTOM CONTROL BAR -->
<div id="bottomBar"
     class="fixed left-1/2 -translate-x-1/2 bottom-4 bg-black/40 backdrop-blur-md 
     px-4 py-2 rounded-full flex items-center gap-4 z-50">

  <button id="btnMic" onclick="toggleMic()" class="text-2xl">ğŸ¤</button>
  <button id="btnCam" onclick="toggleCam()" class="text-2xl">ğŸ“·</button>
  <button id="btnShare" onclick="startScreen()" class="text-2xl">ğŸ–¥ï¸</button>

  <button id="btnRecord" onclick="toggleRecord()" class="bg-orange-500 px-4 py-2 rounded-full font-bold">
    âºï¸ Record
  </button>

  <button onclick="openDonate()" class="bg-green-500 px-4 py-2 rounded-full font-bold">
    ğŸ’° Donate
  </button>
</div>


<!-- DONATE MODAL -->
<div id="donateModal" class="fixed inset-0 bg-black/60 backdrop-blur flex items-center justify-center hidden">
  <div class="bg-white text-black p-6 rounded-xl w-72 text-center">
    <h3 class="text-lg font-bold mb-3">Support AnantKripa</h3>
    <img src="assets/mobile.png" class="mx-auto w-48 rounded-lg shadow">
    <p class="mt-3 text-sm">Scan QR to donate</p>
    <button onclick="closeDonate()" class="mt-4 bg-orange-500 text-white px-4 py-2 rounded-lg w-full">Close</button>
  </div>
</div>


<!-- END MEETING OVERLAY -->
<div id="endedOverlay"
     class="fixed inset-0 hidden items-center justify-center bg-black/80 text-white text-2xl text-center p-6 z-[999]">
  âŒ The host has ended the meeting.<br>Thank you.
</div>


<!-- FILE INPUT FOR SCREENSHOT -->
<input type="file" id="ssFile" accept="image/*" class="hidden" />


<script src="/socket.io/socket.io.js"></script>
<script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
<script>
/* ====== CONFIG & PARAMS ====== */
const urlParams = new URLSearchParams(window.location.search);
const ROOM = (urlParams.get('room') || 'room-default').replace(/\s+/g,'-');
const NAME = urlParams.get('name') || ('Guest' + Math.floor(Math.random()*999));
const IS_HOST = (urlParams.get('host') === '1' || urlParams.get('host') === 'true');
const SERVER = location.origin; // Render app origin
document.getElementById('roomLabel').textContent = 'Room: ' + ROOM;

const ICE_SERVERS = (function(){
  try { return JSON.parse(decodeURIComponent(urlParams.get('ice') || '')) } catch(e){ return (window.__ICE || []) }
})();

/* ====== SOCKET & STATE ====== */
const socket = io(SERVER, { transports: ['websocket','polling'] });

let localStream = null;
let peers = {};             // peerId -> SimplePeer
let peerVideoEls = {};      // peerId -> element
let peerNames = {};         // peerId -> {name, isHost}
let mediaRecorder = null;
let recordedChunks = [];

/* ====== UI helpers ====== */
function showEndedOverlay(){ document.getElementById('endedOverlay').style.display = 'flex'; }
function hideEndedOverlay(){ document.getElementById('endedOverlay').style.display = 'none'; }

/* ====== local media ====== */
async function initLocal() {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
    addVideoEl('local', localStream, NAME + (IS_HOST ? ' (Host)' : ' (You)'), true, IS_HOST);
  } catch(err) {
    console.error('getUserMedia error', err);
    alert('Camera/mic access required to join.');
  }
}

/* ====== socket flow ====== */

// On connect, if host â†’ directly join room, else request approval
socket.on('connect', () => {
  console.log('connected', socket.id, 'host?', IS_HOST);
  if (IS_HOST) {
    socket.emit('join-room', { room: ROOM, userName: NAME, host: true });
    // request current users list (server may not provide; peer-joined events will come)
  } else {
    // ask to join (waiting room)
    socket.emit('join-request', { room: ROOM, userName: NAME });
  }
});

// When server returns peers list (could be array of ids OR array of objects with metadata)
socket.on('peers', async (others) => {
  // handle both shapes: ["id1","id2"] OR [{id,name,isHost}, ...]
  const ids = [];
  if (!Array.isArray(others)) return;
  for (const o of others) {
    if (typeof o === 'string') ids.push(o);
    else if (o && o.id) {
      ids.push(o.id);
      peerNames[o.id] = { name: o.userName || o.name || 'Participant', isHost: !!o.isHost };
    }
  }
  for (const id of ids) {
    await preparePeer(id, true);
  }
});

// server notifies when someone joined after you
socket.on('peer-joined', async ({ id, userName, isHost }) => {
  peerNames[id] = { name: userName || 'Participant', isHost: !!isHost };
  await preparePeer(id, false);
  updateUsersList();
});

// server sends signal messages
socket.on('signal', async ({ from, data }) => {
  if (peers[from]) {
    peers[from].signal(data);
  } else {
    // create peer if offer came
    await preparePeer(from, false, data);
  }
});

// peer left
socket.on('peer-left', ({ id }) => {
  removePeer(id);
  delete peerNames[id];
  updateUsersList();
});

// waiting room - host receives list
socket.on('waiting-user', (list) => {
  // list is array of {id,name}
  const box = document.getElementById('waitingBox');
  const cnt = (list && list.length) || 0;
  document.getElementById('waitingCount').textContent = cnt;
  if (IS_HOST && cnt > 0) {
    box.style.display = 'block';
  } else {
    box.style.display = 'none';
  }
});

// approved to join (guest)
socket.on('approved', (room) => {
  if (room === ROOM) {
    // now officially join the room
    socket.emit('join-room', { room: ROOM, userName: NAME });
  }
});

// meeting ended -> everyone
socket.on('meeting-ended', () => {
  // gracefully stop local media
  if (localStream) {
    localStream.getTracks().forEach(t => t.stop());
  }
  // show overlay and disconnect
  showEndedOverlay();
  setTimeout(() => {
    try { socket.disconnect(); } catch(e){ }
    // optionally redirect to homepage
    // window.location.href = 'https://anantkripa.in';
  }, 1500);
});

/* ====== prepare peer (simple-peer) ====== */
async function preparePeer(peerId, initiator=false, incomingSignal=null) {
  if (peers[peerId]) return;
  const iceConfig = ICE_SERVERS && ICE_SERVERS.length ? ICE_SERVERS : [{ urls: 'stun:stun.l.google.com:19302' }];
  const p = new SimplePeer({ initiator, trickle: true, stream: localStream, config: { iceServers: iceConfig } });
  peers[peerId] = p;

  // when this client generates signaling data
  p.on('signal', data => {
    socket.emit('signal', { to: peerId, data });
  });

  // remote stream received
  p.on('stream', stream => {
    const info = peerNames[peerId] || { name: 'Participant', isHost: false };
    addVideoEl(peerId, stream, info.name + (info.isHost ? ' (Host)' : ''), false, info.isHost);
    updateUsersList();
  });

  p.on('close', () => { removePeer(peerId); });
  p.on('error', e => { console.warn('peer error', e); removePeer(peerId); });

  if (incomingSignal) p.signal(incomingSignal);
}

/* ====== add / remove video elements ====== */
function addVideoEl(id, stream, label, muted=false, isHost=false) {
  // if element exists, update stream
  const existing = document.getElementById('card-' + id);
  if (existing) {
    const vid = existing.querySelector('video');
    if (vid) vid.srcObject = stream;
    const badge = existing.querySelector('.badge');
    if (badge) badge.innerHTML = getBadgeHtml(label, isHost);
    peerVideoEls[id] = existing;
    return;
  }

  const videos = document.getElementById('videos');
  const card = document.createElement('div');
  card.className = 'video-card';
  card.id = 'card-' + id;

  const vid = document.createElement('video');
  vid.autoplay = true;
  vid.playsinline = true;
  vid.muted = !!muted;
  vid.srcObject = stream;

  const badge = document.createElement('div');
  badge.className = 'badge';
  badge.innerHTML = getBadgeHtml(label, isHost);

  card.appendChild(vid);
  card.appendChild(badge);
  videos.appendChild(card);
  peerVideoEls[id] = card;
}

function getBadgeHtml(label, isHost) {
  if (isHost) {
    return `<span class="host-badge">Host</span> <span style="margin-left:8px">${escapeHtml(label)}</span>`;
  }
  return `<span>${escapeHtml(label)}</span>`;
}

function removePeer(id) {
  const el = document.getElementById('card-' + id);
  if (el) el.remove();
  if (peers[id]) { try { peers[id].destroy(); } catch(e){} delete peers[id]; }
  delete peerVideoEls[id];
}

/* ====== Chat ====== */
document.getElementById('sendChat').addEventListener('click', () => {
  const v = document.getElementById('chatInput').value.trim();
  if (!v) return;
  socket.emit('send-chat', { room: ROOM, message: v });
  appendChat(NAME, v);
  document.getElementById('chatInput').value = '';
});
function appendChat(name, msg) {
  const wrap = document.getElementById('messages');
  const el = document.createElement('div');
  el.style.marginBottom = '8px';
  el.innerHTML = `<b>${escapeHtml(name)}:</b> ${escapeHtml(msg)}`;
  wrap.appendChild(el);
  wrap.scrollTop = wrap.scrollHeight;
}

/* ====== emoji ====== */
function localEmoji(emoji) {
  showFloatingEmoji(emoji);
  socket.emit('emoji', { room: ROOM, emoji });
}
function showFloatingEmoji(emoji) {
  const el = document.createElement('div');
  el.className = 'floating-emoji';
  el.textContent = emoji;
  const left = (Math.random()*60 + 20) + '%';
  Object.assign(el.style, {
    left,
    bottom: '110px',
    fontSize: '72px',
    opacity: '0.75',
    transform: 'translateY(0)',
    transition: 'transform 1.8s ease-out, opacity 1.8s ease-out'
  });
  document.body.appendChild(el);
  requestAnimationFrame(() => {
    el.style.transform = 'translateY(-260px)';
    el.style.opacity = '0';
  });
  setTimeout(()=>el.remove(), 1900);
}

/* ====== controls: mic/cam/screenshare ====== */
function toggleMic(){
  if(!localStream) return;
  const audioTrack = localStream.getAudioTracks()[0];
  if(!audioTrack) return;
  audioTrack.enabled = !audioTrack.enabled;
  document.getElementById('btnMic').textContent = audioTrack.enabled ? 'ğŸ¤' : 'ğŸ”‡';
}
function toggleCam(){
  if(!localStream) return;
  const videoTrack = localStream.getVideoTracks()[0];
  if(!videoTrack) return;
  videoTrack.enabled = !videoTrack.enabled;
  document.getElementById('btnCam').textContent = videoTrack.enabled ? 'ğŸ“·' : 'ğŸš«';
}
async function startScreen(){
  try {
    const s = await navigator.mediaDevices.getDisplayMedia({video:true});
    const screenTrack = s.getVideoTracks()[0];
    for(const id in peers) {
      const p = peers[id];
      const sender = p._pc && p._pc.getSenders().find(s => s.track && s.track.kind === 'video');
      if (sender) sender.replaceTrack(screenTrack);
    }
    addVideoEl('screen-local', s, NAME + ' (screen)', true, false);
    screenTrack.onended = () => {
      const camTrack = localStream.getVideoTracks()[0];
      for(const id in peers) {
        const p = peers[id];
        const sender = p._pc && p._pc.getSenders().find(s => s.track && s.track.kind === 'video');
        if (sender && camTrack) sender.replaceTrack(camTrack);
      }
      const el = document.getElementById('card-screen-local');
      if (el) el.remove();
    };
  } catch(e) {
    console.warn('screen share denied', e);
  }
}

/* ====== local recording ====== */
function toggleRecord(){
  if (!mediaRecorder || mediaRecorder.state === 'inactive') startRecording();
  else stopRecording();
}
function startRecording(){
  if (!localStream) return alert('No local stream');
  const combined = new MediaStream();
  localStream.getTracks().forEach(t => combined.addTrack(t));
  mediaRecorder = new MediaRecorder(combined, { mimeType: 'video/webm; codecs=vp8' });
  recordedChunks = [];
  mediaRecorder.ondataavailable = e => { if (e.data.size) recordedChunks.push(e.data); };
  mediaRecorder.onstop = () => {
    const blob = new Blob(recordedChunks, { type: 'video/webm' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `${ROOM}_${Date.now()}.webm`; a.click();
    URL.revokeObjectURL(url);
  };
  mediaRecorder.start();
  document.getElementById('btnRecord').textContent = 'â¹ï¸';
}
function stopRecording(){
  if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
  document.getElementById('btnRecord').textContent = 'âºï¸';
}

/* ====== screenshot upload ====== */
document.getElementById('ssFile').addEventListener('change', (e) => {
  const f = e.target.files[0];
  if (!f) return;
  uploadScreenshotFile(f);
});
async function uploadScreenshotFile(file) {
  const fd = new FormData();
  fd.append('screenshot', file);
  fd.append('room', ROOM);
  const res = await fetch('https://anantkripa.in/upload_screenshot.php', {
    method: 'POST', body: fd, credentials: 'include'
  });
  const j = await res.json();
  if (j.success) alert('Uploaded');
  else alert('Upload failed');
}

/* ====== waiting room actions (host) ====== */
function approveAll(){
  socket.emit('approve-all', ROOM);
  document.getElementById('waitingBox').style.display = 'none';
}

/* ====== participant list update ====== */
function updateUsersList(){
  const wrap = document.getElementById('usersList');
  wrap.innerHTML = '';
  // local first
  const localHtml = `<div class="participant"><div><b>${escapeHtml(NAME)}</b> <div style="font-size:12px;color:#bbb">You${IS_HOST? ' â€¢ Host':''}</div></div><div></div></div>`;
  wrap.insertAdjacentHTML('beforeend', localHtml);
  // other peers
  for (const id in peerNames) {
    const info = peerNames[id] || { name: id, isHost:false };
    const label = escapeHtml(info.name) + (info.isHost ? ' (Host)' : '');
    wrap.insertAdjacentHTML('beforeend', `<div class="participant"><div>${label}</div><div></div></div>`);
  }
}

/* ====== helpers ====== */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>'&#'+c.charCodeAt(0)+';'); }

/* ====== start everything ====== */
(async function(){
  window.__ICE = window.__ICE || (typeof __ICE !== 'undefined' ? __ICE : []);
  await initLocal();
  // If guest, show a small notice while waiting (optional)
  if (!IS_HOST) {
    const notice = document.createElement('div');
    notice.style.position='fixed';
    notice.style.left='50%'; notice.style.top='64px';
    notice.style.transform='translateX(-50%)';
    notice.style.background='#111'; notice.style.color='#fff';
    notice.style.padding='8px 12px'; notice.style.borderRadius='8px';
    notice.style.zIndex=90;
    notice.id='waitingNotice';
    notice.textContent = 'Waiting for host approval...';
    document.body.appendChild(notice);
  }

  // update users list periodically (some peers names arrive later)
  setInterval(updateUsersList, 1200);
})();
</script>
<!-- YOUR ORIGINAL JS SCRIPT BELOW (unchanged) -->
<!-- KEEP your entire existing JS code exactly as it is -->
<!-- just paste your JS here -->
</body>
</html>


